-- Modern Clean Player List + Selectable Target + Safe Auto Grab (Persistent & Optimized)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local UIS = UserInputService
local GrabEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Grab")

local ActivePlayers = {} -- persistent selected players

--== GUI SETUP ==--
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ModernPlayerList"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 180, 0, 240)
Frame.Position = UDim2.new(1, -200, 0.25, 0)
Frame.BackgroundColor3 = Color3.fromRGB(30, 80, 200) -- Blue theme
Frame.BackgroundTransparency = 0
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 14)
UICorner.Parent = Frame

local Scroller = Instance.new("ScrollingFrame")
Scroller.Parent = Frame
Scroller.Size = UDim2.new(1, -10, 1, -10)
Scroller.Position = UDim2.new(0, 5, 0, 5)
Scroller.BackgroundTransparency = 1
Scroller.BorderSizePixel = 0
Scroller.ScrollBarThickness = 3

local UIList = Instance.new("UIListLayout")
UIList.Parent = Scroller
UIList.Padding = UDim.new(0, 6)

local UIPadding = Instance.new("UIPadding")
UIPadding.Parent = Scroller
UIPadding.PaddingTop = UDim.new(0, 6)
UIPadding.PaddingLeft = UDim.new(0, 6)

--== UI BUILDER (efficient refresh) ==--
local function RefreshList()
    for _, child in ipairs(Scroller:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            local item = Instance.new("Frame")
            item.Size = UDim2.new(1, -10, 0, 32)
            item.BackgroundColor3 = Color3.fromRGB(50, 130, 255) -- lighter blue for items
            item.BorderSizePixel = 0
            item.Parent = Scroller

            local icorner = Instance.new("UICorner")
            icorner.CornerRadius = UDim.new(0, 10)
            icorner.Parent = item

            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1, -10, 1, 0)
            label.Position = UDim2.new(0, 10, 0, 0)
            label.BackgroundTransparency = 1
            label.TextColor3 = ActivePlayers[plr] and Color3.fromRGB(0, 255, 150) or Color3.fromRGB(255, 255, 255)
            label.Text = "â€¢ " .. plr.DisplayName
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Font = Enum.Font.GothamMedium
            label.TextSize = 15
            label.Parent = item

            local button = Instance.new("TextButton")
            button.BackgroundTransparency = 1
            button.Size = UDim2.new(1, 0, 1, 0)
            button.Text = ""
            button.Parent = item

            button.MouseButton1Click:Connect(function()
                if ActivePlayers[plr] then
                    ActivePlayers[plr] = nil
                    label.TextColor3 = Color3.fromRGB(255, 255, 255)
                else
                    ActivePlayers[plr] = true
                    label.TextColor3 = Color3.fromRGB(0, 255, 150)
                end
            end)
        end
    end

    Scroller.CanvasSize = UDim2.new(0, 0, 0, UIList.AbsoluteContentSize.Y + 20)
end

Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function()
        RefreshList()
    end)
    RefreshList()
end)

Players.PlayerRemoving:Connect(function(plr)
    ActivePlayers[plr] = nil
    RefreshList()
end)

RefreshList()

--== HIDE / SHOW BUTTON ==--
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 70, 0, 26)
ToggleButton.Position = UDim2.new(1, -200, 0.25 - 0.08, 0)
ToggleButton.BackgroundColor3 = Color3.fromRGB(40, 100, 255)
ToggleButton.TextColor3 = Color3.fromRGB(255,255,255)
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.TextSize = 14
ToggleButton.Text = "Hide"
ToggleButton.Parent = ScreenGui

local tbCorner = Instance.new("UICorner")
tbCorner.CornerRadius = UDim.new(0, 8)
tbCorner.Parent = ToggleButton

ToggleButton.MouseButton1Click:Connect(function()
    Frame.Visible = not Frame.Visible
    ToggleButton.Text = Frame.Visible and "Hide" or "Show"
end)

--== GUIDES BUTTON BESIDE HIDE/SHOW ==--
local GuidesButton = Instance.new("TextButton")
GuidesButton.Size = ToggleButton.Size -- same size
GuidesButton.Position = ToggleButton.Position + UDim2.new(0, 80, 0, 0) -- 80 pixels to the right
GuidesButton.BackgroundColor3 = Color3.fromRGB(60, 140, 255)
GuidesButton.TextColor3 = Color3.fromRGB(255, 255, 255)
GuidesButton.Font = Enum.Font.Gotham
GuidesButton.TextSize = 14
GuidesButton.Text = "Guides"
GuidesButton.Parent = ScreenGui

--== ENABLE / DISABLE WITH KEY ==--
local enabled = true
UIS.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.P then
        enabled = not enabled
        Frame.Visible = enabled
        ToggleButton.Visible = enabled
        GuidesButton.Visible = enabled
    end
end)

--== FIND NEAREST SELECTED PLAYER ==--
local function getNearestActivePlayer(maxDistance)
    local nearestPlayer = nil
    local shortestDistance = maxDistance or 10

    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local root = char.HumanoidRootPart

    for plr, _ in pairs(ActivePlayers) do
        if plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local dist = (root.Position - plr.Character.HumanoidRootPart.Position).Magnitude
            if dist < shortestDistance then
                shortestDistance = dist
                nearestPlayer = plr
            end
        end
    end

    return nearestPlayer
end

--== GRAB FUNCTION ==--
local function grabNearestActive()
    local target = getNearestActivePlayer(10)
    if target and target.Character and target.Character:FindFirstChild("Head") then
        local head = target.Character.Head
        GrabEvent:FireServer(head, "Grab", head.Position, head.CFrame)
    end
end

--== PRESS 2 â†’ SINGLE GRAB ==--
UIS.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.Two then
        grabNearestActive()
    end
end)

--== HOLD 3 â†’ AUTO GRAB UNTIL RELEASE ==--
local holding3 = false
UIS.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.Three then
        if not holding3 then
            holding3 = true
            spawn(function()
                while holding3 do
                    grabNearestActive()
                    wait(0.2)
                end
            end)
        end
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Three then
        holding3 = false
    end
end)

--== POPUP WITH SEMI-TRANSPARENT BACKGROUND ==--
local BGFrame = Instance.new("Frame")
BGFrame.Size = UDim2.new(1,0,1,0)
BGFrame.Position = UDim2.new(0,0,0,0)
BGFrame.BackgroundColor3 = Color3.fromRGB(0,0,0)
BGFrame.BackgroundTransparency = 0.5
BGFrame.Visible = false
BGFrame.Parent = ScreenGui

local PopupFrame = Instance.new("Frame")
PopupFrame.Size = UDim2.new(0, 500, 0, 400)
PopupFrame.Position = UDim2.new(0.5, -250, 0.5, -200)
PopupFrame.BackgroundColor3 = Color3.fromRGB(50, 110, 255)
PopupFrame.BorderSizePixel = 0
PopupFrame.Visible = false
PopupFrame.Parent = ScreenGui

local PopupCorner = Instance.new("UICorner")
PopupCorner.CornerRadius = UDim.new(0,14)
PopupCorner.Parent = PopupFrame

local PopupText = Instance.new("TextLabel")
PopupText.Size = UDim2.new(1, -20, 1, -20)
PopupText.Position = UDim2.new(0, 10, 0, 10)
PopupText.BackgroundTransparency = 1
PopupText.TextColor3 = Color3.fromRGB(255, 255, 255)
PopupText.TextWrapped = true
PopupText.TextYAlignment = Enum.TextYAlignment.Top
PopupText.Font = Enum.Font.Gotham
PopupText.TextSize = 18
PopupText.Text = [[
This script is made
by mchaezter and bobbyðŸŒ¹


Thank you so much for using it.


HERE MY GUIDES:  
Press P - to hide all.
Press 2 to grab.
Hold 3 to autoclick the grab but sadly this can only 1 click but it's hold.

Also even if the player rejoin they will still be detected as activated.
Also don't grab while holding any tools, make sure it is in rope/carry.

This script is only made for PC, sorry if you are on mobile but you can't use it ;(

Thank you for listening! I hope you enjoy using it, bye!
]]
PopupText.Parent = PopupFrame

local CloseButton = Instance.new("TextButton")
CloseButton.Size = ToggleButton.Size
CloseButton.Position = UDim2.new(1, -110, 0, 10)
CloseButton.BackgroundColor3 = Color3.fromRGB(0, 0, 180)
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Font = Enum.Font.Gotham
CloseButton.TextSize = 14
CloseButton.Text = "Close"
CloseButton.Parent = PopupFrame

-- Button Click Events
GuidesButton.MouseButton1Click:Connect(function()
    BGFrame.Visible = true
    PopupFrame.Visible = true
end)

CloseButton.MouseButton1Click:Connect(function()
    BGFrame.Visible = false
    PopupFrame.Visible = false
end)
